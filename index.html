<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brightspace API Tester</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Detect OAuth redirect (?code=...) and auto exchange it ---
        useEffect(() => {
          const params = new URLSearchParams(window.location.search);
          const code = params.get('code');
          if (code) {
            // exchangeCodeForToken is defined later in your component, so defer until after mount
            window.__oauthCode = code; // temporarily store it
            // Clean the URL so ?code disappears after reload
            window.history.replaceState({}, document.title, window.location.pathname);
          }
        }, []);
        // --------------------------------------------------------------

        // Lucide icons as inline SVG components
        const Send = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
        );

        const Trash2 = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
        );

        const Copy = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
        );

        const Check = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
        );

        const Key = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="m15.5 7.5 2.3 2.3a1 1 0 0 0 1.4 0l2.1-2.1a1 1 0 0 0 0-1.4L19 4"></path>
                <path d="m21 2-9.6 9.6"></path>
                <circle cx="7.5" cy="15.5" r="5.5"></circle>
            </svg>
        );

        function BrightspaceAPITester() {
            const [baseUrl, setBaseUrl] = useState('');
            const [clientId, setClientId] = useState('');
            const [clientSecret, setClientSecret] = useState('');
            const [redirectUri, setRedirectUri] = useState('');
            const [scope, setScope] = useState('core:*:*');
            
            const [accessToken, setAccessToken] = useState('');
            const [tokenExpiry, setTokenExpiry] = useState(null);
            const [refreshToken, setRefreshToken] = useState('');
            
            const [method, setMethod] = useState('GET');
            const [endpoint, setEndpoint] = useState('/d2l/api/lp/1.43/users/whoami');
            const [headers, setHeaders] = useState('');
            const [body, setBody] = useState('');
            
            const [response, setResponse] = useState(null);
            const [loading, setLoading] = useState(false);
            const [copied, setCopied] = useState(false);
            const [authStep, setAuthStep] = useState(1);

            // Check token expiry
            useEffect(() => {
                if (tokenExpiry) {
                    const timer = setInterval(() => {
                        if (Date.now() >= tokenExpiry) {
                            setAccessToken('');
                            setTokenExpiry(null);
                        }
                    }, 1000);
                    return () => clearInterval(timer);
                }
            }, [tokenExpiry]);

            // --- Check for stored OAuth code from redirect ---
            useEffect(() => {
                if (window.__oauthCode) {
                    exchangeCodeForToken(window.__oauthCode);
                    delete window.__oauthCode;
                }
            }, []);
            // --------------------------------------------------

            const generateCodeVerifier = () => {
                const array = new Uint8Array(32);
                crypto.getRandomValues(array);
                return btoa(String.fromCharCode.apply(null, array))
                    .replace(/\+/g, '-')
                    .replace(/\//g, '_')
                    .replace(/=/g, '');
            };

            const generateCodeChallenge = async (verifier) => {
                const encoder = new TextEncoder();
                const data = encoder.encode(verifier);
                const hash = await crypto.subtle.digest('SHA-256', data);
                return btoa(String.fromCharCode.apply(null, new Uint8Array(hash)))
                    .replace(/\+/g, '-')
                    .replace(/\//g, '_')
                    .replace(/=/g, '');
            };

            const startOAuthFlow = async () => {
                if (!baseUrl || !clientId || !redirectUri) {
                    alert('Please fill in Base URL, Client ID, and Redirect URI');
                    return;
                }

                const codeVerifier = generateCodeVerifier();
                const codeChallenge = await generateCodeChallenge(codeVerifier);
                
                const state = Math.random().toString(36).substring(7);
                const authData = { codeVerifier, state, clientId, clientSecret, redirectUri, baseUrl };
                sessionStorage.setItem('brightspace_auth', JSON.stringify(authData));

                const authUrl = new URL(`${baseUrl}/d2l/oauth2/authorize`);
                authUrl.searchParams.append('response_type', 'code');
                authUrl.searchParams.append('client_id', clientId);
                authUrl.searchParams.append('redirect_uri', redirectUri);
                authUrl.searchParams.append('scope', scope);
                authUrl.searchParams.append('state', state);
                authUrl.searchParams.append('code_challenge', codeChallenge);
                authUrl.searchParams.append('code_challenge_method', 'S256');

                setAuthStep(2);
                window.open(authUrl.toString(), '_blank');
            };

            const exchangeCodeForToken = async (authCode) => {
                const authData = JSON.parse(sessionStorage.getItem('brightspace_auth'));
                if (!authData) {
                    alert('Authentication session not found. Please start the OAuth flow again.');
                    return;
                }

                try {
                    const tokenUrl = `${authData.baseUrl}/d2l/oauth2/token`;
                    const params = new URLSearchParams({
                        grant_type: 'authorization_code',
                        code: authCode,
                        redirect_uri: authData.redirectUri,
                        client_id: authData.clientId,
                        client_secret: authData.clientSecret,
                        code_verifier: authData.codeVerifier
                    });

                    const res = await fetch(tokenUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: params.toString()
                    });

                    if (!res.ok) {
                        const error = await res.text();
                        throw new Error(`Token exchange failed: ${error}`);
                    }

                    const tokenData = await res.json();
                    setAccessToken(tokenData.access_token);
                    setRefreshToken(tokenData.refresh_token);
                    setTokenExpiry(Date.now() + (tokenData.expires_in * 1000));
                    setAuthStep(3);
                    
                    sessionStorage.removeItem('brightspace_auth');
                } catch (err) {
                    alert(`Error exchanging code for token: ${err.message}`);
                }
            };
